---
title: "Redis学习笔记——01. 基本架构：一个键值数据库包括什么"
date: 2025-02-17
draft: false
tags: ["学习笔记", "Redis"]
categories: ["学习"]
---
# 基本架构：一个键值数据库包括什么？

## 构造SimpleKV

### 里面可以存什么样的数据（数据模型）

对于键值对数据库来说，基本的数据模型是key-value模型，SimpleKV也不例外，在SimpleKV中，key是String类型，而value是基本数据类型，例如String、整型等。对于实际生产中的键值对数据库来说，value类型还可以是复杂类型。

不同键值数据库支持的key类型一般差异不大，而value类型则有较大差别。例如Memcached支持的value类型仅为String类型，而Redis支持的value类型包括了String、哈希表、列表、集合和有序集合等。

### 对数据可以做什么样的操作（操作接口）

SimpleKV需要支持的3种基本操作如下：PUT、GET和DELETE

```
PUT: 新写入或更新一个key-value对
GET: 根据一个key读取相应的value值
DELETE: 根据一个key删除整个key-value对
```

在实际的业务场景中，我们经常会碰到这种情况：查询一个用户在一段时间内的访问记录，这种操作在键值数据库中属于SCAN操作，即根据一段key的范围返回相应的value值。因此，PUT/GET/DELETE/SCAN是一个键值数据库的基本操作集合。

### 架构

一个键值数据库包括了**访问框架**、**索引模块**、**操作模块**和**存储模块**四部分。

![image-20250217160945539](https://lyb-1305354270.cos.ap-beijing.myqcloud.com/lhcos-data/image-20250217160945539.png)

### 采用什么访问模式（访问框架）

访问模式通常有两种：一种是通过函数库调用的方式供外部应用使用；另一种是通过网络框架以Socket通信的形式对外提供键值对操作。

### 如何定位键值对的位置（索引模块）

当SimpleKV解析了客户端发来的请求，知道了要进行的键值对操作，此时SimpleKV需要查找所要操作的键值对是否存在，这依赖于键值数据库的索引模块。索引的作用是让键值数据库根据key找到相应value的存储位置，进而执行操作。

索引的类型有很多，常见的有哈希表、B+树、字典树等。Memcached和Redis采用哈希表作为key-value索引，而RocksDB则采用跳表作为内存中key-value索引。

SimpleKV的索引根据key找到value的存储位置即可，但是对于Redis而言，它的value支持多种类型，当我们通过索引找到一个key所对应的value之后，仍然需要从value的复杂结构中进一步找到我们实际需要的数据，这个操作的效率本身依赖于它们的实现结构。

### 不同操作的具体逻辑是怎样的（操作模块和存储模块）

SimpleKV的索引模块负责根据key找到相应的value的存储位置。对于不同的操作来说，找到存储位置后，需要进一步执行的操作的具体逻辑会有所差异：

对于GET/SCAN操作而言，此时根据value的存储位置返回value值即可；

对于PUT一个新的键值对数据而言，SimpleKV需要为该键值对分配内存空间；

对于DELETE操作，SimpleKV需要删除键值对，并释放相应的内存空间，这个过程由分配器（存储模块）完成。

### 如何实现重启后快速提供服务（存储模块）

SimpleKV采用了常用的内存分配器glibc的malloc和free，因此并不需要特别考虑内存空间的管理问题，但是会存在内存碎片问题。

因此，分配器是键值数据库中的一个关键因素，Redis的内存分配器提供了多种选择，分配效率也不一样。

SimpleKV虽然依赖于内存保存数据，提供快速访问，但是我们也希望SimpleKV在重启后能快速重新提供服务，因此在存储模块中增加了持久化功能。SimpleKV采用了文件形式，将键值数据通过调用本地文件系统的操作接口保存在磁盘上（还需要考虑何时将内存中的键值数据保存到文件中）。