---
title: "Redis学习笔记——26. 缓存异常: 如何解决缓存雪崩、击穿、穿透难题？"
date: 2025-03-17
draft: false
tags: ["学习笔记", "Redis"]
categories: ["学习"]
---

# 缓存异常：如何解决缓存雪崩、击穿、穿透难题？

## 缓存雪崩

缓存雪崩是指大量的应用请求无法在Redis缓存中进行处理，紧接着，应用将大量请求发送到数据库层，导致数据库层的压力激增。

缓存雪崩一般是两个原因导致的，应对方案也有所不同：

第一个原因是：缓存中有大量的数据同时过期，导致大量的请求无法得到处理。

具体来说，当数据保存在缓存中，并设置了过期时间时，如果在某一时刻，大量数据同时过期，此时，应用再访问这些数据的话，就会发生缓存缺失。紧接着，应用把请求发送到数据库，从数据库中读到数据。如果应用的并发请求很大，那么数据库的压力也很大，这就会进一步影响到数据库的其他正常业务请求处理。

![image-20250317215408793](https://lyb-1305354270.cos.ap-beijing.myqcloud.com/lhcos-data/image-20250317215408793.png)

解决方案：

1. 首先，可以避免给大量的数据设置相同的过期时间，如果业务层的确需要有些数据同时失效，可以用EXPIRE命令给每个数据设置过期时间时，给这些数据的过期时间增加一个较小的随机数（比如1～3分钟）。这样一来，不同数据的过期时间有所差别，但差别又不会太大，既避免了大量数据同时过期，也保证了这些数据在基本相近的时间失效，仍然可以满足业务需求。
2. 除了微调过期时间，还可以通过服务降级来应对缓存雪崩。服务降级就是指发生缓存雪崩时，针对不同的数据采用不同的处理方式：当业务应用访问的是非核心数据（例如电商商品属性）时，暂时停止从缓存中查询这些数据，而是直接返回预定义信息、空值或错误信息；当业务应用访问的是核心数据，（例如电商商品库存）时，仍然允许查询缓存，如果缓存缺失，也允许继续从数据库读取。这样一来，只有部分过期的数据的请求会发送到数据库，数据库的压力就没有那么大了。
3. 还可以使用互斥锁。当业务线程在处理用户请求时，如果发现访问的数据不在Redis里，就加个互斥锁，确保同一时间内只有一个请求来构建缓存（从数据库中读数据，然后再将数据更新到Redis里），当缓存构建完成后，再释放锁，未能获取互斥锁的请求，要么等待锁释放后重新读取缓存，要么返回空值或者默认值。

第二个原因是：Redis缓存实例发生故障宕机了，无法处理请求，这就会导致大量请求一下子积压到数据库层，从而发生缓存雪崩。

解决方案：

1. 在业务系统中实现服务熔断或请求限流机制。所谓的服务熔断，就是在发生缓存雪崩的时候，暂停业务应用对缓存系统的接口访问。再具体点说，就是业务应用调用缓存接口时，缓存客户端不再把请求发给Redis缓存实例，而是直接返回，等到Redis实例重新恢复服务后，再允许把请求发送到缓存系统。在业务系统运⾏时，我们可以监测 Redis 缓存所在机器和数据库所在机器的负载指标，例如每秒请求数、CPU 利⽤率、内存利⽤率等。如果我们发现 Redis 缓存实例宕机了，⽽数据库所在机器的负载压⼒突然增加（例如每秒请求数激增），此时，就发⽣缓存雪崩了。⼤量请求被发送到数据库进⾏处理。我们可以启动服务熔断机制，暂停业务应⽤对缓存服务的访问，从⽽降低对数据库的访问压⼒。但是该方法对业务应⽤的影响范围⼤，为了尽可能减少这种影响，我们也可以进⾏请求限流。这⾥说的请求限流，就是指，我们在业务系统的请求⼊⼝前端控制每秒进⼊系统的请求数，避免过多的请求被发送到数据库。（事后诸葛亮）

   ![image-20250317221326609](https://lyb-1305354270.cos.ap-beijing.myqcloud.com/lhcos-data/image-20250317221326609.png)

2. 通过主从节点的方式构建Redis缓存高可用集群。如果Redis缓存的主节点故障宕机了，从节点还可以切换成主节点，继续提供缓存服务，避免了由于缓存实例宕机而导致的缓存雪崩问题。（事前预防）

## 缓存击穿

缓存击穿是指，针对某个访问非常频繁的热点数据的请求，无法在缓存中进行处理，紧接着，访问该数据的大量请求，一下都发送到了后端数据库，导致了数据库压力骤增，会影响数据库其他处理请求。缓存击穿的情况，经常发生在热点数据过期失效时，如图：

![image-20250317222137910](https://lyb-1305354270.cos.ap-beijing.myqcloud.com/lhcos-data/image-20250317222137910.png)

解决方案：

对于访问特别频繁的热点数据，我们就不设置过期时间了，由后台异步更新缓存，这样一来对数据的访问请求，都可以在缓存中进行处理。

## 缓存穿透

缓存穿透是指要访问的数据既不在缓存中，也不在数据库中导致请求在访问缓存时发生缓存缺失，再去访问数据时，发现数据库中也没有要访问的数据，此时应用无法从数据库中读取数据并写入缓存，来服务后续请求。如果应用持续有大量的请求访问数据，就会同时给缓存和数据库带来压力，如图：

![image-20250317222701079](https://lyb-1305354270.cos.ap-beijing.myqcloud.com/lhcos-data/image-20250317222701079.png)

一般发生在：业务层误操作（缓存中的数据和数据库的数据都被删除了）或者恶意攻击（专门访问数据库中没有的数据）。

解决方案：

1. 缓存空值或缺省值。⼀旦发⽣缓存穿透，我们就可以针对查询的数据，在 Redis 中缓存⼀个空值或是和业务层协商确定的缺省值（例如，库存的缺省值可以设为 0）。紧接着，应⽤发送的后续请求再进⾏查询时，就可以直接从 Redis 中读取空值或缺省值，返回给业务应⽤了，避免了把⼤量请求发送给数据库处理，保持了数据库的正常运⾏。

2. 使用布隆过滤器快速判断数据是否存在，避免从数据库中查询数据是否存在，减轻数据压力。我们可以在把数据写⼊数据库时，使⽤布隆过滤器做个标记。当缓存缺失后，应⽤查询数据库时，可以通过查询布隆过滤器快速判断数据是否存在。如果不存在，就不⽤再去数据库中查询了。这样⼀来，即使发⽣缓存穿透了，⼤量请求只会查询 Redis 和布隆过滤器，⽽不会积压到数据库，也就不会影响数据库的正常运⾏。

   ![image-20250317223048560](https://lyb-1305354270.cos.ap-beijing.myqcloud.com/lhcos-data/image-20250317223048560.png)

3. 在请求入口的前端进行请求检测。⼀个有效的应对⽅案是在请求⼊⼝前端，对业务系统接收到的请求

   进⾏合法性检测，把恶意的请求（例如请求参数不合理、请求参数是⾮法值、请求字段不存在）直接过滤掉，不让它们访问后端缓存和数据库。这样⼀来，也就不会出现缓存穿透问题了。